<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¥ ECS WASM „Éû„É´„ÉÅ„Éó„É¨„Ç§„ÇΩ„É™„ÉÜ„Ç£„Ç¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            overflow-x: auto;
        }

        .header {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #2ed573;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .game-container {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 140px);
            padding: 20px;
            gap: 20px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #54a0ff, #2e86de);
            box-shadow: 0 4px 15px rgba(84, 160, 255, 0.3);
        }

        .btn.secondary:hover {
            box-shadow: 0 6px 20px rgba(84, 160, 255, 0.4);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .game-board {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-height: 500px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 200px;
            gap: 20px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .card-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        /* Windows„ÇΩ„É™„ÉÜ„Ç£„Ç¢Â∞ÇÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .solitaire-board {
            display: flex !important;
            flex-direction: column;
            gap: 30px;
            padding: 20px;
            background: #0f7b0f;
            border-radius: 15px;
            min-height: 600px;
        }

        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .deck-area {
            display: flex;
            gap: 20px;
        }

        .deck-slot, .waste-slot {
            width: 80px;
            height: 120px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .deck-card {
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .deck-card:hover {
            transform: scale(1.05);
        }

        .foundation-area {
            display: flex;
            gap: 15px;
        }

        .foundation-slot {
            width: 80px;
            height: 120px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
        }

        .foundation-placeholder {
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }

        .tableau-area {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tableau-column {
            width: 80px;
            min-height: 200px;
            position: relative;
        }

        .tableau-card {
            width: 80px;
            height: 120px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
            margin-bottom: -100px; /* „Ç´„Éº„Éâ„ÅÆÈáç„Å™„Çä„ÇíË°®Áèæ */
        }
        
        .tableau-card:last-child {
            margin-bottom: 0; /* ÊúÄÂæå„ÅÆ„Ç´„Éº„Éâ„ÅØÈáç„Å™„Çâ„Å™„ÅÑ */
        }

        .tableau-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .tableau-card.selected {
            transform: translateY(-10px);
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.8);
            border: 3px solid #ffd700;
        }

        .waste-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .waste-card:hover {
            transform: scale(1.05);
        }

        .card-rank.top-left {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        .card-rank.bottom-right {
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 14px;
            font-weight: bold;
            transform: rotate(180deg);
        }

        .card-suit.center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
        }

        /* „Ç´„Éº„Éâ„ÅåÁßªÂãï‰∏≠„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .card.moving {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }
        
        /* „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÈñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
        .card.dragging {
            opacity: 0.8;
            transform: scale(1.1) rotate(5deg);
            z-index: 2000;
            cursor: grabbing;
            pointer-events: none;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }
        
        .card.draggable {
            cursor: grab;
        }
        
        .card.draggable:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }
        
        .drop-zone {
            border: 3px dashed rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .drop-zone.drag-over {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        .drop-zone.valid-drop {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.2);
        }
        
        .drop-zone.invalid-drop {
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.2);
        }
        
        /* „Éâ„É©„ÉÉ„Ç∞„Éó„É¨„Éì„É•„Éº */
        .drag-preview {
            position: fixed;
            pointer-events: none;
            z-index: 3000;
            opacity: 0.9;
            transform: rotate(-10deg);
        }

        /* ÂãùÂà©ÊôÇ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .victory-card {
            animation: victoryBounce 0.6s ease-in-out;
        }

        @keyframes victoryBounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-20px);
            }
            60% {
                transform: translateY(-10px);
            }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 1024px) {
            .solitaire-board {
                padding: 10px;
            }
            
            .foundation-area {
                gap: 10px;
            }
            
            .tableau-area {
                gap: 10px;
            }
            
            .deck-slot, .waste-slot, .foundation-slot {
                width: 70px;
                height: 105px;
            }
            
            .tableau-column {
                width: 70px;
            }
            
            .tableau-card {
                width: 70px;
                height: 105px;
            }
        }

        @media (max-width: 768px) {
            .top-row {
                flex-direction: column;
                gap: 20px;
                align-items: center;
            }
            
            .deck-area {
                justify-content: center;
            }
            
            .foundation-area {
                justify-content: center;
            }
            
            .deck-slot, .waste-slot, .foundation-slot {
                width: 60px;
                height: 90px;
            }
            
            .tableau-column {
                width: 60px;
            }
            
            .tableau-card {
                width: 60px;
                height: 90px;
            }
            
            .card-suit.center {
                font-size: 24px;
            }
        }

        .card {
            width: 80px;
            height: 120px;
            background: linear-gradient(45deg, #fff, #f8f9fa);
            border: 2px solid #dee2e6;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
            font-weight: bold;
            font-size: 12px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .card.red {
            color: #e74c3c;
        }

        .card.black {
            color: #2c3e50;
        }

        .card.face-down {
            background: linear-gradient(45deg, #3742fa, #2f3542);
            color: transparent;
        }

        .card.face-down::before {
            content: 'üé¥';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: white;
        }
        
        .card.hint-highlight {
            border: 3px solid #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            animation: hintPulse 1s ease-in-out infinite alternate;
        }
        
        @keyframes hintPulse {
            0% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
            100% {
                box-shadow: 0 0 30px rgba(255, 215, 0, 1);
            }
        }

        .card-suit {
            font-size: 18px;
            text-align: center;
        }

        .card-rank {
            font-size: 14px;
            font-weight: bold;
        }

        .message-area {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .message {
            margin-bottom: 5px;
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .player-info {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .player {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            min-width: 120px;
        }

        .player.active {
            background: rgba(255, 193, 7, 0.3);
            border: 2px solid #ffc107;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .player-score {
            font-size: 14px;
            opacity: 0.8;
        }

        /* „Éû„Ç¶„Çπ„Ç´„Éº„ÇΩ„É´Ë°®Á§∫Áî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .remote-cursor {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
            transition: all 0.1s ease;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
        }

        .cursor-icon {
            width: 20px;
            height: 20px;
            position: relative;
        }

        .cursor-icon::before {
            content: 'üëÜ';
            font-size: 18px;
            position: absolute;
            top: -2px;
            left: -2px;
        }

        .cursor-label {
            position: absolute;
            top: 25px;
            left: 5px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cursor-trail {
            position: absolute;
            width: 4px;
            height: 4px;
            background: currentColor;
            border-radius: 50%;
            pointer-events: none;
            animation: cursorTrail 0.8s ease-out forwards;
        }

        @keyframes cursorTrail {
            0% {
                opacity: 0.8;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.2);
            }
        }

        /* „Éó„É¨„Ç§„É§„ÉºÊØé„ÅÆËâ≤ÂàÜ„Åë */
        .remote-cursor.player-1 {
            color: #ff6b6b;
        }

        .remote-cursor.player-2 {
            color: #4ecdc4;
        }

        .remote-cursor.player-3 {
            color: #45b7d1;
        }

        .remote-cursor.player-4 {
            color: #f9ca24;
        }

        .remote-cursor.player-5 {
            color: #f0932b;
        }

        /* „Éû„Ç¶„Çπ„Ç´„Éº„ÇΩ„É´ÊÉÖÂ†±Ë°®Á§∫„Ç®„É™„Ç¢ */
        .cursor-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 200px;
            z-index: 999;
        }

        .cursor-info h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #ffc107;
        }

        .cursor-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }

            .status-bar {
                flex-direction: column;
                gap: 10px;
            }

            .player-info {
                flex-direction: column;
                gap: 10px;
            }

            .card-area {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            }

            .card {
                width: 60px;
                height: 90px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé¥ ECS WASM „Éû„É´„ÉÅ„Éó„É¨„Ç§„ÇΩ„É™„ÉÜ„Ç£„Ç¢</h1>
        <p>Rust ECS„Ç®„É≥„Ç∏„É≥ √ó WebAssembly √ó „É™„Ç¢„É´„Çø„Ç§„É†ÈÄö‰ø°</p>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <div class="status-indicator" id="connectionStatus"></div>
            <span id="connectionText">Êé•Á∂ö‰∏≠...</span>
        </div>
        <div class="status-item">
            <span>üéØ „Ç≤„Éº„É†: </span>
            <span id="gameStatus">ÂæÖÊ©ü‰∏≠</span>
        </div>
        <div class="status-item">
            <span>‚è±Ô∏è ÁµåÈÅéÊôÇÈñì: </span>
            <span id="gameTime">00:00</span>
        </div>
    </div>

    <div class="game-container">
        <div class="controls">
            <button class="btn" id="initGameBtn">üéÆ „Ç≤„Éº„É†ÂàùÊúüÂåñ</button>
            <button class="btn secondary" id="newGameBtn" disabled>üÜï Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†</button>
            <button class="btn secondary" id="connectBtn" disabled>üåê „Çµ„Éº„Éê„ÉºÊé•Á∂ö</button>
            <button class="btn secondary" id="shuffleBtn" disabled>üîÄ „Ç∑„É£„ÉÉ„Éï„É´</button>
            <button class="btn secondary" id="hintBtn" disabled>üí° „Éí„É≥„Éà</button>
        </div>

        <div class="player-info" id="playerInfo" style="display: none;">
            <!-- „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
        </div>

        <div class="game-board">
            <div class="loading" id="loadingArea">
                <div class="spinner"></div>
                <p>WebAssembly„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
            </div>

            <div class="card-area" id="cardArea" style="display: none;">
                <!-- „Ç´„Éº„Éâ„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
            </div>
        </div>

        <div class="message-area" id="messageArea">
            <div class="message">üéÆ ECS WASM „ÇΩ„É™„ÉÜ„Ç£„Ç¢„Ç≤„Éº„É†„ÇíÈñãÂßã„Åó„Åæ„Åô...</div>
            <div class="message">üì¶ WebAssembly„É¢„Ç∏„É•„Éº„É´„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
        </div>
    </div>

    <!-- „Éû„Ç¶„Çπ„Ç´„Éº„ÇΩ„É´ÊÉÖÂ†±Ë°®Á§∫„Ç®„É™„Ç¢ -->
    <div class="cursor-info" id="cursorInfo" style="display: none;">
        <h4>üëÜ „Ç™„É≥„É©„Ç§„É≥„Éó„É¨„Ç§„É§„Éº</h4>
        <div id="cursorList">
            <!-- „Ç´„Éº„ÇΩ„É´ÊÉÖÂ†±„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
        </div>
    </div>

    <script type="module">
        // WebAssembly„É¢„Ç∏„É•„Éº„É´„ÅÆË™≠„ÅøËæº„Åø
        import init, { 
            initialize_game, 
            start_new_game, 
            update_game, 
            get_connection_status,
            get_solitaire_state,
            move_card,
            draw_card_from_deck,
            reset_solitaire_game,
            try_auto_place,
            check_victory,
            get_hint
        } from './pkg/ecs_wasm_solitaire.js';

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let wasmModule = null;
        let gameRunning = false;
        let gameStartTime = null;
        let animationFrame = null;
        let lastUpdate = performance.now();
        
        // „Éû„Ç¶„Çπ„Ç´„Éº„ÇΩ„É´Èñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let localPlayerId = null;
        let remoteCursors = new Map(); // playerId -> cursor data
        let webSocket = null;
        let mousePosition = { x: 0, y: 0 };
        let lastMouseSent = 0;
        const MOUSE_SEND_INTERVAL = 50; // 50msÈñìÈöî„Åß„Éû„Ç¶„Çπ‰ΩçÁΩÆ„ÇíÈÄÅ‰ø°
        
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÈñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let draggedCard = null;
        let dragStartPos = { x: 0, y: 0 };
        let dragOffset = { x: 0, y: 0 };
        let isDragging = false;
        let dragPreview = null;
        let dropZones = [];
        let currentDropZone = null;

        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
        const elements = {
            loadingArea: document.getElementById('loadingArea'),
            cardArea: document.getElementById('cardArea'),
            messageArea: document.getElementById('messageArea'),
            playerInfo: document.getElementById('playerInfo'),
            connectionStatus: document.getElementById('connectionStatus'),
            connectionText: document.getElementById('connectionText'),
            gameStatus: document.getElementById('gameStatus'),
            gameTime: document.getElementById('gameTime'),
            initGameBtn: document.getElementById('initGameBtn'),
            newGameBtn: document.getElementById('newGameBtn'),
            connectBtn: document.getElementById('connectBtn'),
            shuffleBtn: document.getElementById('shuffleBtn'),
            hintBtn: document.getElementById('hintBtn'),
            cursorInfo: document.getElementById('cursorInfo'),
            cursorList: document.getElementById('cursorList')
        };

        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Èñ¢Êï∞
        function addMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            elements.messageArea.appendChild(messageDiv);
            elements.messageArea.scrollTop = elements.messageArea.scrollHeight;
        }

        // „Ç≤„Éº„É†ÊôÇÈñìÊõ¥Êñ∞Èñ¢Êï∞
        function updateGameTime() {
            if (gameStartTime) {
                const elapsed = Date.now() - gameStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                elements.gameTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Êé•Á∂öÁä∂ÊÖãÊõ¥Êñ∞Èñ¢Êï∞
        function updateConnectionStatus(connected = false) {
            if (connected) {
                elements.connectionStatus.classList.add('connected');
                elements.connectionText.textContent = 'Êé•Á∂öÊ∏à„Åø';
            } else {
                elements.connectionStatus.classList.remove('connected');
                elements.connectionText.textContent = 'ÂàáÊñ≠‰∏≠';
            }
        }

        // „Éû„Ç¶„Çπ„Ç´„Éº„ÇΩ„É´Èñ¢ÈÄ£„ÅÆÈñ¢Êï∞Áæ§
        function createRemoteCursor(playerId, playerName, playerIndex = 1) {
            // Êó¢Â≠ò„ÅÆ„Ç´„Éº„ÇΩ„É´„ÇíÂâäÈô§
            removeRemoteCursor(playerId);
            
            const cursorDiv = document.createElement('div');
            cursorDiv.className = `remote-cursor player-${playerIndex}`;
            cursorDiv.id = `cursor-${playerId}`;
            cursorDiv.style.display = 'none';
            
            cursorDiv.innerHTML = `
                <div class="cursor-icon"></div>
                <div class="cursor-label">${playerName}</div>
            `;
            
            document.body.appendChild(cursorDiv);
            
            remoteCursors.set(playerId, {
                element: cursorDiv,
                name: playerName,
                index: playerIndex,
                lastUpdate: Date.now(),
                x: 0,
                y: 0
            });
            
            updateCursorInfo();
            addMessage(`üëÜ ${playerName} „ÅÆ„Ç´„Éº„ÇΩ„É´„ÅåË°®Á§∫„Åï„Çå„Åæ„Åó„Åü`);
        }

        function updateRemoteCursor(playerId, x, y) {
            const cursorData = remoteCursors.get(playerId);
            if (!cursorData) return;
            
            const { element } = cursorData;
            element.style.display = 'block';
            element.style.left = `${x}px`;
            element.style.top = `${y}px`;
            
            // ËªåË∑°„Ç®„Éï„Çß„ÇØ„Éà„ÇíËøΩÂä†
            createCursorTrail(x, y, cursorData.index);
            
            // „Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            cursorData.x = x;
            cursorData.y = y;
            cursorData.lastUpdate = Date.now();
        }

        function removeRemoteCursor(playerId) {
            const cursorData = remoteCursors.get(playerId);
            if (cursorData && cursorData.element) {
                cursorData.element.remove();
            }
            remoteCursors.delete(playerId);
            updateCursorInfo();
        }

        function createCursorTrail(x, y, playerIndex) {
            const trail = document.createElement('div');
            trail.className = `cursor-trail player-${playerIndex}`;
            trail.style.left = `${x}px`;
            trail.style.top = `${y}px`;
            
            document.body.appendChild(trail);
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫ÜÂæå„Å´Ë¶ÅÁ¥†„ÇíÂâäÈô§
            setTimeout(() => {
                trail.remove();
            }, 800);
        }

        function updateCursorInfo() {
            const cursorCount = remoteCursors.size;
            
            if (cursorCount > 0) {
                elements.cursorInfo.style.display = 'block';
                elements.cursorList.innerHTML = '';
                
                remoteCursors.forEach((cursorData, playerId) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'cursor-info-item';
                    itemDiv.innerHTML = `
                        <span class="player-${cursorData.index}">${cursorData.name}</span>
                        <span>(${Math.round(cursorData.x)}, ${Math.round(cursorData.y)})</span>
                    `;
                    elements.cursorList.appendChild(itemDiv);
                });
            } else {
                elements.cursorInfo.style.display = 'none';
            }
        }

        function sendMousePosition(x, y) {
            if (!webSocket || webSocket.readyState !== WebSocket.OPEN) return;
            
            const now = Date.now();
            if (now - lastMouseSent < MOUSE_SEND_INTERVAL) return;
            
            const message = {
                type: 'MousePosition',
                player_id: localPlayerId,
                x: x,
                y: y,
                timestamp: now
            };
            
            webSocket.send(JSON.stringify(message));
            lastMouseSent = now;
        }

        function handleWebSocketMessage(event) {
            try {
                const message = JSON.parse(event.data);
                console.log('üì• Âèó‰ø°„É°„ÉÉ„Çª„Éº„Ç∏:', message);
                
                switch (message.type) {
                    case 'PlayerJoin':
                        createRemoteCursor(
                            message.player_id, 
                            message.player_name, 
                            message.player_index || 1
                        );
                        addMessage(`üéÆ ${message.player_name} „ÅåÂèÇÂä†„Åó„Åæ„Åó„Åü`);
                        break;
                        
                    case 'PlayerLeft':
                        removeRemoteCursor(message.player_id);
                        addMessage(`üëã ${message.player_name} „ÅåÈÄÄÂá∫„Åó„Åæ„Åó„Åü`);
                        break;
                        
                    case 'MousePosition':
                        if (message.player_id !== localPlayerId) {
                            updateRemoteCursor(message.player_id, message.x, message.y);
                        }
                        break;
                        
                    case 'GameAction':
                        addMessage(`üéØ ${message.player_name}: ${message.action}`);
                        break;
                        
                    case 'Error':
                        addMessage(`‚ùå „Çµ„Éº„Éê„Éº„Ç®„É©„Éº: ${message.message}`);
                        break;
                        
                    default:
                        console.log('Êú™Áü•„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Çø„Ç§„Éó:', message.type);
                        addMessage(`‚ö†Ô∏è Êú™Áü•„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏: ${message.type}`);
                }
            } catch (error) {
                console.error('WebSocket message parse error:', error);
                addMessage(`‚ùå „É°„ÉÉ„Çª„Éº„Ç∏Ëß£Êûê„Ç®„É©„Éº: ${error.message}`);
            }
        }

        // „ÉÜ„Çπ„ÉàÁî®„ÅÆ„ÉÄ„Éü„Éº„Ç´„Éº„ÇΩ„É´ÁîüÊàêÈñ¢Êï∞
        function createTestCursors() {
            const testPlayers = [
                { id: 'test-alice', name: 'Alice', index: 1 },
                { id: 'test-bob', name: 'Bob', index: 2 },
                { id: 'test-carol', name: 'Carol', index: 3 }
            ];
            
            testPlayers.forEach((player, i) => {
                createRemoteCursor(player.id, player.name, player.index);
                
                // „É©„É≥„ÉÄ„É†„Å™‰ΩçÁΩÆ„Å´„Ç´„Éº„ÇΩ„É´„ÇíÈÖçÁΩÆ
                const x = 200 + i * 150 + Math.random() * 100;
                const y = 300 + Math.random() * 200;
                updateRemoteCursor(player.id, x, y);
            });
            
            addMessage('üß™ „ÉÜ„Çπ„ÉàÁî®„Ç´„Éº„ÇΩ„É´„Çí3„Å§‰ΩúÊàê„Åó„Åæ„Åó„Åü');
        }

        // Windows„ÇΩ„É™„ÉÜ„Ç£„Ç¢„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíË°®Á§∫
        function displayWindowsSolitaire() {
            elements.cardArea.innerHTML = '';
            elements.cardArea.className = 'solitaire-board';
            
            // Windows„ÇΩ„É™„ÉÜ„Ç£„Ç¢„ÅÆÊ≠£Á¢∫„Å™„É¨„Ç§„Ç¢„Ç¶„Éà„Çí‰ΩúÊàê
            const boardHTML = `
                <!-- ‰∏äÊÆµÔºö„Éá„ÉÉ„Ç≠„ÄÅ„Ç¶„Çß„Ç§„Çπ„Éà„ÄÅ„Éï„Ç°„Ç¶„É≥„Éá„Éº„Ç∑„Éß„É≥ -->
                <div class="top-row">
                    <!-- „Éá„ÉÉ„Ç≠„Ç®„É™„Ç¢ -->
                    <div class="deck-area">
                        <div class="deck-slot" id="deckSlot">
                            <div class="card face-down deck-card" id="deck">üé¥</div>
                        </div>
                        <div class="waste-slot" id="wasteSlot">
                            <!-- „Ç¶„Çß„Ç§„Çπ„Éà„Ç´„Éº„Éâ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                    </div>
                    
                    <!-- „Éï„Ç°„Ç¶„É≥„Éá„Éº„Ç∑„Éß„É≥„Ç®„É™„Ç¢ -->
                    <div class="foundation-area">
                        <div class="foundation-slot" data-foundation="0">
                            <div class="foundation-placeholder">‚ô†<br>A</div>
                        </div>
                        <div class="foundation-slot" data-foundation="1">
                            <div class="foundation-placeholder">‚ô•<br>A</div>
                        </div>
                        <div class="foundation-slot" data-foundation="2">
                            <div class="foundation-placeholder">‚ô¶<br>A</div>
                        </div>
                        <div class="foundation-slot" data-foundation="3">
                            <div class="foundation-placeholder">‚ô£<br>A</div>
                        </div>
                    </div>
                </div>
                
                <!-- ‰∏ãÊÆµÔºö„Çø„Éñ„É≠„ÉºÔºà7ÂàóÔºâ -->
                <div class="tableau-area">
                    ${Array.from({length: 7}, (_, i) => `
                        <div class="tableau-column" data-column="${i}">
                            <!-- „Çø„Éñ„É≠„Éº„Ç´„Éº„Éâ„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                        </div>
                    `).join('')}
                </div>
            `;
            
            elements.cardArea.innerHTML = boardHTML;
            
            // Windows„ÇΩ„É™„ÉÜ„Ç£„Ç¢„ÅÆ„Ç´„Éº„ÉâÈÖçÁΩÆ„Çí„Ç∑„Éü„É•„É¨„Éº„Éà
            createWindowsSolitaireCards();
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            setupSolitaireEventListeners();
        }
        
        // Windows„ÇΩ„É™„ÉÜ„Ç£„Ç¢„ÅÆ„Ç´„Éº„ÉâÈÖçÁΩÆ„Çí‰ΩúÊàê
        function createWindowsSolitaireCards() {
            const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
            const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            
            // 52Êûö„ÅÆ„Ç´„Éº„Éâ„Éá„ÉÉ„Ç≠„Çí‰ΩúÊàê
            const deck = [];
            suits.forEach(suit => {
                ranks.forEach(rank => {
                    deck.push({ suit, rank, isRed: suit === '‚ô•' || suit === '‚ô¶' });
                });
            });
            
            // „Ç´„Éº„Éâ„Çí„Ç∑„É£„ÉÉ„Éï„É´ÔºàÁ∞°Âçò„Å™ÂÆüË£ÖÔºâ
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            
            let cardIndex = 0;
            
            // „Çø„Éñ„É≠„Éº„Å´„Ç´„Éº„Éâ„ÇíÈÖçÁΩÆÔºàWindows„ÇΩ„É™„ÉÜ„Ç£„Ç¢„ÅÆ„É´„Éº„É´ÈÄö„ÇäÔºâ
            for (let column = 0; column < 7; column++) {
                const columnDiv = document.querySelector(`[data-column="${column}"]`);
                
                // ÂêÑÂàó„Å´1„Äú7Êûö„ÅÆ„Ç´„Éº„Éâ„ÇíÈÖçÁΩÆ
                for (let row = 0; row <= column; row++) {
                    if (cardIndex >= deck.length) break;
                    
                    const card = deck[cardIndex];
                    const cardDiv = document.createElement('div');
                    cardDiv.className = `card tableau-card ${card.isRed ? 'red' : 'black'}`;
                    cardDiv.dataset.suit = card.suit;
                    cardDiv.dataset.rank = card.rank;
                    cardDiv.dataset.cardIndex = cardIndex;
                    
                    // ÊúÄ‰∏ä‰Ωç„ÅÆ„Ç´„Éº„Éâ„ÅÆ„ÅøË°®Âêë„Åç
                    const isFaceUp = (row === column);
                    if (isFaceUp) {
                        cardDiv.innerHTML = `
                            <div class="card-rank top-left">${card.rank}</div>
                            <div class="card-suit center">${card.suit}</div>
                            <div class="card-rank bottom-right">${card.rank}</div>
                        `;
                    } else {
                        cardDiv.classList.add('face-down');
                        cardDiv.innerHTML = 'üé¥';
                    }
                    
                    // Èáç„Å™„Çä„ÇíË°®Áèæ
                    cardDiv.style.position = 'absolute';
                    cardDiv.style.top = `${row * 25}px`;
                    cardDiv.style.zIndex = row;
                    
                    columnDiv.appendChild(cardDiv);
                    cardIndex++;
                }
            }
            
            addMessage(`üéÆ Windows„ÇΩ„É™„ÉÜ„Ç£„Ç¢ÈÖçÁΩÆÂÆå‰∫Ü: „Çø„Éñ„É≠„Éº${cardIndex}Êûö, „Éá„ÉÉ„Ç≠${deck.length - cardIndex}Êûö`);
        }
        
        // „ÇΩ„É™„ÉÜ„Ç£„Ç¢Â∞ÇÁî®„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
        function setupSolitaireEventListeners() {
            // „Éá„ÉÉ„Ç≠„ÇØ„É™„ÉÉ„ÇØÔºà„Ç´„Éº„Éâ„ÇíÂºï„ÅèÔºâ
            document.getElementById('deck').addEventListener('click', () => {
                addMessage('üé¥ „Éá„ÉÉ„Ç≠„Åã„Çâ„Ç´„Éº„Éâ„ÇíÂºï„Åç„Åæ„Åó„Åü');
                drawCardFromDeck();
            });
            
            // „Ç´„Éº„Éâ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            document.addEventListener('click', (event) => {
                if (event.target.classList.contains('tableau-card')) {
                    handleCardClick(event.target);
                }
            });
            
            // „Ç´„Éº„Éâ„ÅÆ„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØÔºàËá™ÂãïÈÖçÁΩÆÔºâ
            document.addEventListener('dblclick', (event) => {
                if (event.target.classList.contains('tableau-card') || 
                    event.target.classList.contains('waste-card')) {
                    handleCardDoubleClick(event.target);
                }
            });
            
            // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            setupDragAndDrop();
        }
        
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÊ©üËÉΩ„ÅÆË®≠ÂÆö
        function setupDragAndDrop() {
            // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÇíÁâπÂÆö
            dropZones = [
                ...document.querySelectorAll('.foundation-slot'),
                ...document.querySelectorAll('.tableau-column'),
                document.getElementById('wasteSlot')
            ];
            
            // „Ç´„Éº„Éâ„Å´„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Éï„É©„Ç∞„ÇíË®≠ÂÆö
            updateDraggableCards();
            
            // „Ç∞„É≠„Éº„Éê„É´„Å™„Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            document.addEventListener('mousedown', handleMouseDown);
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            
            // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÂØæÂøú
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd, { passive: false });
        }
        
        // „Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Å™„Ç´„Éº„Éâ„ÇíÊõ¥Êñ∞
        function updateDraggableCards() {
            // „Åô„Åπ„Å¶„ÅÆ„Ç´„Éº„Éâ„Åã„Çâ„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Éï„É©„Ç∞„ÇíÂâäÈô§
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('draggable');
            });
            
            // „Çø„Éñ„É≠„Éº„ÅÆÊúÄ‰∏ä‰Ωç„Ç´„Éº„Éâ„Çí „Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Å´„Åô„Çã
            document.querySelectorAll('.tableau-column').forEach(column => {
                const cards = column.querySelectorAll('.tableau-card:not(.face-down)');
                if (cards.length > 0) {
                    const topCard = cards[cards.length - 1];
                    topCard.classList.add('draggable');
                }
            });
            
            // „Ç¶„Çß„Ç§„Çπ„Éà„Ç´„Éº„Éâ„Çí„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Å´„Åô„Çã
            const wasteCards = document.querySelectorAll('.waste-card');
            if (wasteCards.length > 0) {
                wasteCards[wasteCards.length - 1].classList.add('draggable');
            }
        }
        
        // „Éû„Ç¶„Çπ„ÉÄ„Ç¶„É≥„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
        function handleMouseDown(event) {
            const card = event.target.closest('.card.draggable');
            if (!card) return;
            
            event.preventDefault();
            startDrag(card, event.clientX, event.clientY);
        }
        
        // „Çø„ÉÉ„ÉÅ„Çπ„Çø„Éº„Éà„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
        function handleTouchStart(event) {
            const card = event.target.closest('.card.draggable');
            if (!card) return;
            
            event.preventDefault();
            const touch = event.touches[0];
            startDrag(card, touch.clientX, touch.clientY);
        }
        
        // „Éâ„É©„ÉÉ„Ç∞ÈñãÂßã
        function startDrag(card, clientX, clientY) {
            draggedCard = card;
            isDragging = true;
            
            const rect = card.getBoundingClientRect();
            dragOffset.x = clientX - rect.left;
            dragOffset.y = clientY - rect.top;
            dragStartPos.x = clientX;
            dragStartPos.y = clientY;
            
            // „Éâ„É©„ÉÉ„Ç∞„Éó„É¨„Éì„É•„Éº„Çí‰ΩúÊàê
            createDragPreview(card, clientX, clientY);
            
            // „Ç´„Éº„Éâ„Å´„Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
            card.classList.add('dragging');
            
            // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„Çí„Éè„Ç§„É©„Ç§„Éà
            highlightDropZones(card);
            
            addMessage(`üñ±Ô∏è „Éâ„É©„ÉÉ„Ç∞ÈñãÂßã: ${card.dataset.rank}${card.dataset.suit}`);
        }
        
        // „Éâ„É©„ÉÉ„Ç∞„Éó„É¨„Éì„É•„Éº„Çí‰ΩúÊàê
        function createDragPreview(card, clientX, clientY) {
            dragPreview = card.cloneNode(true);
            dragPreview.classList.add('drag-preview');
            dragPreview.classList.remove('draggable', 'dragging');
            dragPreview.style.left = `${clientX - dragOffset.x}px`;
            dragPreview.style.top = `${clientY - dragOffset.y}px`;
            dragPreview.style.width = `${card.offsetWidth}px`;
            dragPreview.style.height = `${card.offsetHeight}px`;
            
            document.body.appendChild(dragPreview);
        }
        
        // „Éû„Ç¶„ÇπÁßªÂãï„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
        function handleMouseMove(event) {
            if (!isDragging || !dragPreview) return;
            
            updateDragPreview(event.clientX, event.clientY);
            updateDropZoneHighlight(event.clientX, event.clientY);
        }
        
        // „Çø„ÉÉ„ÉÅÁßªÂãï„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
        function handleTouchMove(event) {
            if (!isDragging || !dragPreview) return;
            
            event.preventDefault();
            const touch = event.touches[0];
            updateDragPreview(touch.clientX, touch.clientY);
            updateDropZoneHighlight(touch.clientX, touch.clientY);
        }
        
        // „Éâ„É©„ÉÉ„Ç∞„Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
        function updateDragPreview(clientX, clientY) {
            dragPreview.style.left = `${clientX - dragOffset.x}px`;
            dragPreview.style.top = `${clientY - dragOffset.y}px`;
        }
        
        // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíÊõ¥Êñ∞
        function updateDropZoneHighlight(clientX, clientY) {
            const elementUnder = document.elementFromPoint(clientX, clientY);
            const dropZone = elementUnder ? elementUnder.closest('.foundation-slot, .tableau-column, #wasteSlot') : null;
            
            // Ââç„ÅÆ„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíÂâäÈô§
            if (currentDropZone && currentDropZone !== dropZone) {
                currentDropZone.classList.remove('drag-over', 'valid-drop', 'invalid-drop');
            }
            
            currentDropZone = dropZone;
            
            if (dropZone) {
                dropZone.classList.add('drag-over');
                
                // „Éâ„É≠„ÉÉ„Éó„ÅåÊúâÂäπ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (isValidDrop(draggedCard, dropZone)) {
                    dropZone.classList.add('valid-drop');
                    dropZone.classList.remove('invalid-drop');
                } else {
                    dropZone.classList.add('invalid-drop');
                    dropZone.classList.remove('valid-drop');
                }
            }
        }
        
        // „Éû„Ç¶„Çπ„Ç¢„ÉÉ„Éó„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
        function handleMouseUp(event) {
            if (!isDragging) return;
            
            finishDrag(event.clientX, event.clientY);
        }
        
        // „Çø„ÉÉ„ÉÅ„Ç®„É≥„Éâ„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
        function handleTouchEnd(event) {
            if (!isDragging) return;
            
            event.preventDefault();
            const touch = event.changedTouches[0];
            finishDrag(touch.clientX, touch.clientY);
        }
        
        // „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü
        function finishDrag(clientX, clientY) {
            if (!draggedCard) return;
            
            const elementUnder = document.elementFromPoint(clientX, clientY);
            const dropZone = elementUnder ? elementUnder.closest('.foundation-slot, .tableau-column, #wasteSlot') : null;
            
            let success = false;
            
            if (dropZone && isValidDrop(draggedCard, dropZone)) {
                success = performDrop(draggedCard, dropZone);
                
                if (success) {
                    addMessage(`‚úÖ „Ç´„Éº„ÉâÁßªÂãïÊàêÂäü: ${draggedCard.dataset.rank}${draggedCard.dataset.suit}`);
                    
                    // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Åß„Éñ„É≠„Éº„Éâ„Ç≠„É£„Çπ„Éà
                    broadcastCardMove(draggedCard, dropZone);
                } else {
                    addMessage(`‚ùå „Ç´„Éº„ÉâÁßªÂãïÂ§±Êïó: ${draggedCard.dataset.rank}${draggedCard.dataset.suit}`);
                }
            } else {
                addMessage(`‚ùå ÁÑ°Âäπ„Å™ÁßªÂãïÂÖà: ${draggedCard.dataset.rank}${draggedCard.dataset.suit}`);
            }
            
            // „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            cleanupDrag(success);
        }
        
        // „Éâ„É≠„ÉÉ„Éó„ÅåÊúâÂäπ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isValidDrop(card, dropZone) {
            if (!card || !dropZone) return false;
            
            const cardSuit = card.dataset.suit;
            const cardRank = card.dataset.rank;
            
            if (dropZone.classList.contains('foundation-slot')) {
                // „Éï„Ç°„Ç¶„É≥„Éá„Éº„Ç∑„Éß„É≥„Å∏„ÅÆ„Éâ„É≠„ÉÉ„Éó„É´„Éº„É´
                return isValidFoundationDrop(cardSuit, cardRank, dropZone);
            } else if (dropZone.classList.contains('tableau-column')) {
                // „Çø„Éñ„É≠„Éº„Å∏„ÅÆ„Éâ„É≠„ÉÉ„Éó„É´„Éº„É´
                return isValidTableauDrop(cardSuit, cardRank, dropZone);
            }
            
            return false;
        }
        
        // „Éï„Ç°„Ç¶„É≥„Éá„Éº„Ç∑„Éß„É≥„Å∏„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÅåÊúâÂäπ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isValidFoundationDrop(cardSuit, cardRank, foundation) {
            const foundationCards = foundation.querySelectorAll('.card:not(.foundation-placeholder)');
            
            if (foundationCards.length === 0) {
                // Á©∫„ÅÆ„Éï„Ç°„Ç¶„É≥„Éá„Éº„Ç∑„Éß„É≥: A„ÅÆ„Åø
                return cardRank === 'A';
            }
            
            const topCard = foundationCards[foundationCards.length - 1];
            const topSuit = topCard.dataset.suit;
            const topRank = topCard.dataset.rank;
            
            // Âêå„Åò„Çπ„Éº„Éà„ÅßÊ¨°„ÅÆÊï∞Â≠ó
            return cardSuit === topSuit && getNextRank(topRank) === cardRank;
        }
        
        // „Çø„Éñ„É≠„Éº„Å∏„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÅåÊúâÂäπ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isValidTableauDrop(cardSuit, cardRank, tableau) {
            const tableauCards = tableau.querySelectorAll('.tableau-card:not(.face-down)');
            
            if (tableauCards.length === 0) {
                // Á©∫„ÅÆ„Çø„Éñ„É≠„Éº: K„ÅÆ„Åø
                return cardRank === 'K';
            }
            
            const topCard = tableauCards[tableauCards.length - 1];
            const topSuit = topCard.dataset.suit;
            const topRank = topCard.dataset.rank;
            
            // Áï∞„Å™„ÇãËâ≤„Åß1Â∞è„Åï„ÅÑÊï∞Â≠ó
            const cardColor = getCardColor(cardSuit);
            const topColor = getCardColor(topSuit);
            
            return cardColor !== topColor && getPreviousRank(topRank) === cardRank;
        }
        
        // ÂÆüÈöõ„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÇíÂÆüË°å
        function performDrop(card, dropZone) {
            try {
                // Rust„ÅÆWebAssemblyÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó„Å¶ÁßªÂãï„ÅÆÂ¶•ÂΩìÊÄß„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const fromLocation = JSON.stringify({
                    type: getCardLocation(card),
                    position: getCardPosition(card)
                });
                
                const toLocation = JSON.stringify({
                    type: getDropZoneType(dropZone),
                    position: getDropZonePosition(dropZone)
                });
                
                const moveResult = move_card(fromLocation, toLocation);
                
                if (moveResult) {
                    // DOM‰∏ä„Åß„Ç´„Éº„Éâ„ÇíÁßªÂãï
                    moveCardToDropZone(card, dropZone);
                    updateGameDisplay();
                    updateDraggableCards();
                    return true;
                }
            } catch (error) {
                console.error('„Ç´„Éº„ÉâÁßªÂãï„Ç®„É©„Éº:', error);
            }
            
            return false;
        }
        
        // DOM‰∏ä„Åß„Ç´„Éº„Éâ„ÇíÁßªÂãï
        function moveCardToDropZone(card, dropZone) {
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„Åç„Åß„Ç´„Éº„Éâ„ÇíÁßªÂãï
            const dropRect = dropZone.getBoundingClientRect();
            const cardRect = card.getBoundingClientRect();
            
            // Êó¢Â≠ò„ÅÆ„Çπ„Çø„Ç§„É´„Çí„É™„Çª„ÉÉ„Éà
            card.style.position = '';
            card.style.top = '';
            card.style.left = '';
            card.style.transform = '';
            card.style.transition = 'all 0.3s ease';
            
            // Ê≠£Á¢∫„Å™ÁßªÂãïË∑ùÈõ¢„ÇíË®àÁÆó
            const deltaX = dropRect.left - cardRect.left;
            const deltaY = dropRect.top - cardRect.top;
            card.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
            
            setTimeout(() => {
                // ÁßªÂãïÂÖà„Å´„Ç´„Éº„Éâ„ÇíÈÖçÁΩÆ
                card.style.transition = '';
                card.style.transform = '';
                card.style.position = '';
                card.style.top = '';
                card.style.left = '';
                
                if (dropZone.classList.contains('foundation-slot')) {
                    // „Éï„Ç°„Ç¶„É≥„Éá„Éº„Ç∑„Éß„É≥„ÅÆÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„ÅæËøΩÂä†
                    dropZone.appendChild(card);
                } else if (dropZone.classList.contains('tableau-column')) {
                    // „Çø„Éñ„É≠„Éº„ÅÆÂ†¥Âêà„ÅØÈÅ©Âàá„Å™‰ΩçÁΩÆ„Å´ÈÖçÁΩÆ
                    const existingCards = dropZone.querySelectorAll('.tableau-card');
                    
                    // „Çø„Éñ„É≠„Éº„Ç´„Éº„Éâ„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
                    card.className = 'card tableau-card ' + (card.classList.contains('red') ? 'red' : 'black');
                    
                    // CSS„ÅßÂÆöÁæ©„Åó„Åü„Çπ„Çø„Ç§„É´„Çí‰ΩøÁî®Ôºàposition: relative„Å®margin-bottom„ÅßÈáç„Å™„Çä„ÇíË°®ÁèæÔºâ
                    // ËøΩÂä†„ÅÆ„Çπ„Çø„Ç§„É´Ë™øÊï¥„ÅØÂøÖË¶Å„Å™„Åó - CSS„ÅåËá™Âãï„ÅßÂá¶ÁêÜ
                    
                    dropZone.appendChild(card);
                } else {
                    // „Åù„ÅÆ‰ªñ„ÅÆÂ†¥ÂêàÔºà„Ç¶„Çß„Ç§„Çπ„Éà„Å™„Å©Ôºâ
                    dropZone.appendChild(card);
                }
                
                // „Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                updateDraggableCards();
                
                // ÂãùÂà©Êù°‰ª∂„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                checkVictoryCondition();
            }, 300);
        }
        
        // „Ç´„Éº„Éâ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Éñ„É≠„Éº„Éâ„Ç≠„É£„Çπ„Éà
        function broadcastCardMove(card, dropZone) {
            if (webSocket && webSocket.readyState === WebSocket.OPEN) {
                const moveMessage = {
                    type: 'GameAction',
                    player_id: localPlayerId,
                    player_name: 'Player1', // TODO: ÂÆüÈöõ„ÅÆ„Éó„É¨„Ç§„É§„ÉºÂêç„Çí‰ΩøÁî®
                    action: `„Ç´„Éº„ÉâÁßªÂãï: ${card.dataset.rank}${card.dataset.suit} ‚Üí ${getDropZoneDescription(dropZone)}`,
                    timestamp: Date.now()
                };
                webSocket.send(JSON.stringify(moveMessage));
            }
        }
        
        // „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        function cleanupDrag(success) {
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
                
                if (!success) {
                    // Â§±ÊïóÊôÇ„ÅØ„Ç´„Éº„Éâ„ÇíÂÖÉ„ÅÆ‰ΩçÁΩÆ„Å´Êàª„Åô
                    animateCardBack(draggedCard);
                }
            }
            
            if (dragPreview) {
                dragPreview.remove();
                dragPreview = null;
            }
            
            // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíÂâäÈô§
            dropZones.forEach(zone => {
                zone.classList.remove('drag-over', 'valid-drop', 'invalid-drop');
            });
            
            draggedCard = null;
            isDragging = false;
            currentDropZone = null;
        }
        
        // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„Çí„Éè„Ç§„É©„Ç§„Éà
        function highlightDropZones(card) {
            dropZones.forEach(zone => {
                zone.classList.add('drop-zone');
            });
        }
        
        // „Ç´„Éº„Éâ„ÇíÂÖÉ„ÅÆ‰ΩçÁΩÆ„Å´Êàª„Åô„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        function animateCardBack(card) {
            // Êó¢Â≠ò„ÅÆ„Çπ„Çø„Ç§„É´„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶ÂÖÉ„ÅÆ‰ΩçÁΩÆ„Å´Êàª„Åô
            card.style.transition = 'all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
            card.style.transform = '';
            card.style.position = '';
            card.style.top = '';
            card.style.left = '';
            
            setTimeout(() => {
                card.style.transition = '';
                // „Éâ„É©„ÉÉ„Ç∞Èñ¢ÈÄ£„ÅÆ„ÇØ„É©„Çπ„ÇÇÁ¢∫ÂÆü„Å´ÂâäÈô§
                card.classList.remove('dragging', 'selected');
            }, 500);
        }
        
        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞Áæ§
        function getCardColor(suit) {
            return (suit === '‚ô•' || suit === '‚ô¶') ? 'red' : 'black';
        }
        
        function getNextRank(rank) {
            const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const index = ranks.indexOf(rank);
            return index < ranks.length - 1 ? ranks[index + 1] : null;
        }
        
        function getPreviousRank(rank) {
            const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const index = ranks.indexOf(rank);
            return index > 0 ? ranks[index - 1] : null;
        }
        
        function getCardLocation(card) {
            if (card.classList.contains('tableau-card')) return 'tableau';
            if (card.classList.contains('waste-card')) return 'waste';
            if (card.closest('.foundation-slot')) return 'foundation';
            return 'unknown';
        }
        
        function getCardPosition(card) {
            const parent = card.parentElement;
            if (parent.classList.contains('tableau-column')) {
                return parseInt(parent.dataset.column) || 0;
            }
            if (parent.classList.contains('foundation-slot')) {
                return parseInt(parent.dataset.foundation) || 0;
            }
            return 0;
        }
        
        function getDropZoneType(dropZone) {
            if (dropZone.classList.contains('foundation-slot')) return 'foundation';
            if (dropZone.classList.contains('tableau-column')) return 'tableau';
            if (dropZone.id === 'wasteSlot') return 'waste';
            return 'unknown';
        }
        
        function getDropZonePosition(dropZone) {
            if (dropZone.dataset.column) return parseInt(dropZone.dataset.column);
            if (dropZone.dataset.foundation) return parseInt(dropZone.dataset.foundation);
            return 0;
        }
        
        function getDropZoneDescription(dropZone) {
            if (dropZone.classList.contains('foundation-slot')) {
                return `„Éï„Ç°„Ç¶„É≥„Éá„Éº„Ç∑„Éß„É≥${parseInt(dropZone.dataset.foundation) + 1}`;
            }
            if (dropZone.classList.contains('tableau-column')) {
                return `„Çø„Éñ„É≠„ÉºÂàó${parseInt(dropZone.dataset.column) + 1}`;
            }
            return '„Ç¶„Çß„Ç§„Çπ„Éà';
        }
        
        // „Éá„ÉÉ„Ç≠„Åã„Çâ„Ç´„Éº„Éâ„ÇíÂºï„ÅèÂá¶ÁêÜ
        function drawCardFromDeck() {
            try {
                // Rust„ÅÆWebAssemblyÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                const cardInfoJson = draw_card_from_deck();
                
                if (!cardInfoJson) {
                    addMessage('‚ö†Ô∏è „Éá„ÉÉ„Ç≠„Å´„Ç´„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                const cardInfo = JSON.parse(cardInfoJson);
                const wasteSlot = document.getElementById('wasteSlot');
                
                // Êó¢Â≠ò„ÅÆ„Ç¶„Çß„Ç§„Çπ„Éà„Ç´„Éº„Éâ„ÇíÂâäÈô§
                wasteSlot.innerHTML = '';
                
                // Êñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„ÇíË°®Á§∫
                const isRed = cardInfo.suit === '‚ô•' || cardInfo.suit === '‚ô¶';
                
                const wasteCard = document.createElement('div');
                wasteCard.className = `card waste-card ${isRed ? 'red' : 'black'}`;
                wasteCard.dataset.suit = cardInfo.suit;
                wasteCard.dataset.rank = cardInfo.rank;
                wasteCard.innerHTML = `
                    <div class="card-rank top-left">${cardInfo.rank}</div>
                    <div class="card-suit center">${cardInfo.suit}</div>
                    <div class="card-rank bottom-right">${cardInfo.rank}</div>
                `;
                
                wasteSlot.appendChild(wasteCard);
                
                addMessage(`üé¥ „Éá„ÉÉ„Ç≠„Åã„Çâ${cardInfo.rank}${cardInfo.suit}„ÇíÂºï„Åç„Åæ„Åó„Åü`);
                
                // „Ç≤„Éº„É†Áä∂ÊÖã„ÇíÊõ¥Êñ∞
                updateGameDisplay();
                
            } catch (error) {
                addMessage(`‚ùå „Ç´„Éº„ÉâÊèèÁîª„Ç®„É©„Éº: ${error.message}`);
                console.error('Draw card error:', error);
            }
        }
        
        // „Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function handleCardClick(cardElement) {
            const suit = cardElement.dataset.suit;
            const rank = cardElement.dataset.rank;
            
            // „Ç´„Éº„Éâ„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„Éà„Ç∞„É´
            if (cardElement.classList.contains('selected')) {
                cardElement.classList.remove('selected');
                addMessage(`‚ùå „Ç´„Éº„ÉâÈÅ∏ÊäûËß£Èô§: ${rank}${suit}`);
            } else {
                // ‰ªñ„ÅÆÈÅ∏Êäû„Åï„Çå„Åü„Ç´„Éº„Éâ„ÇíËß£Èô§
                document.querySelectorAll('.card.selected').forEach(card => {
                    card.classList.remove('selected');
                });
                
                cardElement.classList.add('selected');
                addMessage(`‚úÖ „Ç´„Éº„ÉâÈÅ∏Êäû: ${rank}${suit}`);
            }
        }
        
        // „Ç´„Éº„Éâ„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜÔºàËá™ÂãïÈÖçÁΩÆÔºâ
        function handleCardDoubleClick(cardElement) {
            const suit = cardElement.dataset.suit;
            const rank = cardElement.dataset.rank;
            
            addMessage(`üöÄ Ëá™ÂãïÈÖçÁΩÆË©¶Ë°å: ${rank}${suit}`);
            
            try {
                // „Ç´„Éº„ÉâÊÉÖÂ†±„ÇíJSON„Åß‰ΩúÊàê
                const cardInfo = JSON.stringify({
                    suit: suit,
                    rank: rank,
                    face_up: true
                });
                
                // Rust„ÅÆWebAssemblyÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                const success = try_auto_place(cardInfo);
                
                if (success) {
                    addMessage(`‚ú® Ëá™ÂãïÈÖçÁΩÆÊàêÂäü: ${rank}${suit}`);
                    
                    // ÊàêÂäü„Åó„ÅüÂ†¥Âêà„ÅØ„Ç´„Éº„Éâ„ÇíÂÆüÈöõ„Å´ÁßªÂãïÔºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„ÅçÔºâ
                    animateCardMove(cardElement);
                    
                    // „Ç≤„Éº„É†Áä∂ÊÖã„ÇíÊõ¥Êñ∞
                    updateGameDisplay();
                    
                    // ÂãùÂà©Êù°‰ª∂„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    checkVictoryCondition();
                } else {
                    addMessage(`‚ö†Ô∏è Ëá™ÂãïÈÖçÁΩÆ„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü: ${rank}${suit}`);
                }
                
            } catch (error) {
                addMessage(`‚ùå Ëá™ÂãïÈÖçÁΩÆ„Ç®„É©„Éº: ${error.message}`);
                console.error('Auto place error:', error);
            }
        }
        
        // „Ç´„Éº„ÉâÁßªÂãï„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        function animateCardMove(cardElement) {
            cardElement.classList.add('moving');
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫ÜÂæå„Å´„Ç´„Éº„Éâ„ÇíÂâäÈô§
            setTimeout(() => {
                cardElement.style.transform = 'translateY(-200px) scale(0.8)';
                cardElement.style.opacity = '0';
                
                setTimeout(() => {
                    cardElement.remove();
                }, 300);
            }, 100);
        }
        
        // ÂãùÂà©Êù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
        function checkVictoryCondition() {
            try {
                const victory = check_victory();
                
                if (victory) {
                    addMessage('üéâ „Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ„Ç≤„Éº„É†„ÇØ„É™„Ç¢„Åß„ÅôÔºÅ');
                    
                    // ÂãùÂà©„Ç®„Éï„Çß„ÇØ„Éà
                    document.querySelectorAll('.card').forEach((card, index) => {
                        setTimeout(() => {
                            card.classList.add('victory-card');
                        }, index * 100);
                    });
                    
                    // „Ç≤„Éº„É†ÂÅúÊ≠¢
                    gameRunning = false;
                    elements.gameStatus.textContent = '„Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ';
                }
                
            } catch (error) {
                console.error('Victory check error:', error);
            }
        }

        // „Ç≤„Éº„É†Áä∂ÊÖã„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateGameDisplay() {
            try {
                // Rust„ÅÆWebAssemblyÈñ¢Êï∞„Åã„Çâ„Ç≤„Éº„É†Áä∂ÊÖã„ÇíÂèñÂæó
                const gameStateJson = get_solitaire_state();
                const gameState = JSON.parse(gameStateJson);
                
                // „Çπ„Ç≥„Ç¢„Å®ÁßªÂãïÂõûÊï∞„ÇíË°®Á§∫Êõ¥Êñ∞
                addMessage(`üìä Áä∂ÊÖãÊõ¥Êñ∞: ÁßªÂãï${gameState.moves}Âõû, „Çπ„Ç≥„Ç¢${gameState.score}ÁÇπ`);
                
                // TODO: „Çø„Éñ„É≠„Éº„Å®„Éï„Ç°„Ç¶„É≥„Éá„Éº„Ç∑„Éß„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
                
            } catch (error) {
                console.error('Game display update error:', error);
            }
        }
        
        // „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±Ë°®Á§∫Èñ¢Êï∞Ôºà„ÉÜ„Çπ„ÉàÁî®Ôºâ
        function displayTestPlayers() {
            elements.playerInfo.innerHTML = '';
            const players = [
                { name: 'Alice', score: 150, active: true },
                { name: 'Bob', score: 120, active: false },
                { name: 'Carol', score: 200, active: false }
            ];
            
            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `player ${player.active ? 'active' : ''}`;
                playerDiv.innerHTML = `
                    <div class="player-name">${player.name}</div>
                    <div class="player-score">„Çπ„Ç≥„Ç¢: ${player.score}</div>
                `;
                elements.playerInfo.appendChild(playerDiv);
            });
            
            elements.playerInfo.style.display = 'flex';
        }

        // „Ç≤„Éº„É†„É´„Éº„ÉóÈñ¢Êï∞
        function gameLoop(currentTime) {
            if (!gameRunning) return;
            
            const deltaTime = currentTime - lastUpdate;
            lastUpdate = currentTime;
            
            // WebAssembly„ÅÆupdate_gameÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
            if (wasmModule && typeof update_game === 'function') {
                update_game(deltaTime);
            }
            
            // „Ç≤„Éº„É†ÊôÇÈñìÊõ¥Êñ∞
            updateGameTime();
            
            // Ê¨°„ÅÆ„Éï„É¨„Éº„É†„Çí‰∫àÁ¥Ñ
            animationFrame = requestAnimationFrame(gameLoop);
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        elements.initGameBtn.addEventListener('click', async () => {
            try {
                addMessage('üéÆ „Ç≤„Éº„É†„ÇíÂàùÊúüÂåñ‰∏≠...');
                elements.initGameBtn.disabled = true;
                
                if (wasmModule && typeof initialize_game === 'function') {
                    const result = initialize_game();
                    if (result) {
                        addMessage('‚úÖ „Ç≤„Éº„É†ÂàùÊúüÂåñÂÆå‰∫ÜÔºÅ');
                        elements.newGameBtn.disabled = false;
                        elements.connectBtn.disabled = false;
                        elements.gameStatus.textContent = 'ÂàùÊúüÂåñÂÆå‰∫Ü';
                        
                        // Windows„ÇΩ„É™„ÉÜ„Ç£„Ç¢„ÅÆË°®Á§∫
                        displayWindowsSolitaire();
                        displayTestPlayers();
                        
                        elements.cardArea.style.display = 'grid';
                    } else {
                        addMessage('‚ùå „Ç≤„Éº„É†ÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                } else {
                    addMessage('‚ö†Ô∏è WebAssembly„É¢„Ç∏„É•„Éº„É´„ÅåÊ≠£„Åó„ÅèË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
            } catch (error) {
                addMessage(`‚ùå „Ç®„É©„Éº: ${error.message}`);
                console.error('Game initialization error:', error);
            }
        });

        elements.newGameBtn.addEventListener('click', () => {
            try {
                addMessage('üÜï Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†„ÇíÈñãÂßã‰∏≠...');
                
                if (wasmModule && typeof start_new_game === 'function') {
                    const playerName = 'Player1'; // Âæå„Åß„É¶„Éº„Ç∂„ÉºÂÖ•Âäõ„Å´„Åô„Çã
                    const sessionId = start_new_game(playerName);
                    
                    addMessage(`üéØ „Ç≤„Éº„É†ÈñãÂßãÔºÅ„Çª„ÉÉ„Ç∑„Éß„É≥ID: ${sessionId}`);
                    elements.gameStatus.textContent = '„Éó„É¨„Ç§‰∏≠';
                    gameStartTime = Date.now();
                    gameRunning = true;
                    
                    // „Ç≤„Éº„É†„É´„Éº„ÉóÈñãÂßã
                    lastUpdate = performance.now();
                    animationFrame = requestAnimationFrame(gameLoop);
                    
                    // „Éú„Çø„É≥Áä∂ÊÖãÊõ¥Êñ∞
                    elements.shuffleBtn.disabled = false;
                    elements.hintBtn.disabled = false;
                } else {
                    addMessage('‚ö†Ô∏è „Ç≤„Éº„É†ÈñãÂßãÈñ¢Êï∞„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                }
            } catch (error) {
                addMessage(`‚ùå „Ç®„É©„Éº: ${error.message}`);
                console.error('New game error:', error);
            }
        });

        elements.connectBtn.addEventListener('click', () => {
            addMessage('üåê WebSocket„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö‰∏≠...');
            
            try {
                webSocket = new WebSocket('ws://162.43.8.148:8101');
                
                webSocket.onopen = () => {
                    updateConnectionStatus(true);
                    addMessage('‚úÖ WebSocket„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü');
                    
                    // „Éó„É¨„Ç§„É§„ÉºID„ÇíÁîüÊàê
                    localPlayerId = `player_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    
                    // ÂèÇÂä†„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
                    const joinMessage = {
                        type: 'PlayerJoin',
                        player_id: localPlayerId,
                        player_name: 'Player1' // Âæå„Åß„É¶„Éº„Ç∂„ÉºÂÖ•Âäõ„Å´„Åô„Çã
                    };
                    webSocket.send(JSON.stringify(joinMessage));
                    addMessage(`üë§ „Éó„É¨„Ç§„É§„Éº„Å®„Åó„Å¶ÂèÇÂä†: ${localPlayerId}`);
                };
                
                webSocket.onmessage = handleWebSocketMessage;
                
                webSocket.onclose = () => {
                    updateConnectionStatus(false);
                    addMessage('‚ùå WebSocketÊé•Á∂ö„ÅåÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü');
                    
                    // Êé•Á∂ö„ÅåÂàá„Çå„ÅüÂ†¥Âêà„ÅØ„ÉÜ„Çπ„Éà„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
                    setTimeout(() => {
                        updateConnectionStatus(true);
                        addMessage('üîÑ „ÉÜ„Çπ„Éà„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü');
                        localPlayerId = `test_player_${Date.now()}`;
                        createTestCursors();
                        startTestCursorAnimation();
                    }, 2000);
                };
                
                webSocket.onerror = (error) => {
                    updateConnectionStatus(false);
                    addMessage(`‚ùå WebSocketÊé•Á∂ö„Ç®„É©„Éº: ${error.message || '„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü'}`);
                    
                    // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÇÇ„ÉÜ„Çπ„Éà„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
                    setTimeout(() => {
                        updateConnectionStatus(true);
                        addMessage('üîÑ „ÉÜ„Çπ„Éà„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü');
                        localPlayerId = `test_player_${Date.now()}`;
                        createTestCursors();
                        startTestCursorAnimation();
                    }, 2000);
                };
                
            } catch (error) {
                addMessage(`‚ùå WebSocketÊé•Á∂öÂ§±Êïó: ${error.message}`);
                
                // Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØ„ÉÜ„Çπ„Éà„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
                setTimeout(() => {
                    updateConnectionStatus(true);
                    addMessage('üîÑ „ÉÜ„Çπ„Éà„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü');
                    localPlayerId = `test_player_${Date.now()}`;
                    createTestCursors();
                    startTestCursorAnimation();
                }, 2000);
            }
        });

        elements.shuffleBtn.addEventListener('click', () => {
            try {
                addMessage('üîÄ „Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà‰∏≠...');
                
                // Rust„ÅÆWebAssemblyÈñ¢Êï∞„Åß„Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
                const success = reset_solitaire_game();
                
                if (success) {
                    addMessage('‚úÖ „Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
                    
                    // Ë°®Á§∫„ÇíÂÜçÊßãÁØâ
                    displayWindowsSolitaire();
                    updateGameDisplay();
                } else {
                    addMessage('‚ùå „Ç≤„Éº„É†„É™„Çª„ÉÉ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
                
            } catch (error) {
                addMessage(`‚ùå „É™„Çª„ÉÉ„Éà„Ç®„É©„Éº: ${error.message}`);
                console.error('Reset error:', error);
            }
        });

        elements.hintBtn.addEventListener('click', () => {
            try {
                addMessage('üí° „Éí„É≥„Éà„ÇíÂèñÂæó‰∏≠...');
                
                // Rust„ÅÆWebAssemblyÈñ¢Êï∞„Åß„Éí„É≥„Éà„ÇíÂèñÂæó
                const hintJson = get_hint();
                const hint = JSON.parse(hintJson);
                
                addMessage(`üí° „Éí„É≥„Éà: ${hint.message}`);
                
                // „Éí„É≥„Éà„Å´Âæì„Å£„Å¶Ë¶ñË¶öÁöÑ„Å™ÊåáÁ§∫„ÇíË°®Á§∫
                highlightHintCards(hint);
                
            } catch (error) {
                addMessage(`‚ùå „Éí„É≥„ÉàÂèñÂæó„Ç®„É©„Éº: ${error.message}`);
                console.error('Hint error:', error);
            }
        });
        
        // „Éí„É≥„Éà„Å´Âü∫„Å•„ÅÑ„Å¶„Ç´„Éº„Éâ„Çí„Éè„Ç§„É©„Ç§„Éà
        function highlightHintCards(hint) {
            // Ââç„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíÂâäÈô§
            document.querySelectorAll('.card.hint-highlight').forEach(card => {
                card.classList.remove('hint-highlight');
            });
            
            if (hint.from && hint.to) {
                // „Éí„É≥„ÉàÂØæË±°„Ç´„Éº„Éâ„Çí3ÁßíÈñì„Éè„Ç§„É©„Ç§„Éà
                setTimeout(() => {
                    document.querySelectorAll('.card.hint-highlight').forEach(card => {
                        card.classList.remove('hint-highlight');
                    });
                }, 3000);
            }
        }

        // WebAssemblyÂàùÊúüÂåñ
        async function initializeWasm() {
            try {
                addMessage('üì¶ WebAssembly„É¢„Ç∏„É•„Éº„É´„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
                
                wasmModule = await init();
                
                addMessage('‚úÖ WebAssembly„É¢„Ç∏„É•„Éº„É´„ÅÆË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÔºÅ');
                addMessage('üéÆ „Ç≤„Éº„É†ÂàùÊúüÂåñ„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                
                elements.loadingArea.style.display = 'none';
                elements.initGameBtn.disabled = false;
                
                // Êé•Á∂öÁä∂ÊÖã„ÇíÂÆöÊúüÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØÔºà„ÉÜ„Çπ„ÉàÁî®Ôºâ
                setInterval(() => {
                    if (wasmModule && typeof get_connection_status === 'function') {
                        const status = get_connection_status();
                        // addMessage(`üì° Êé•Á∂öÁä∂ÊÖã: ${status}`);
                    }
                }, 5000);
                
            } catch (error) {
                addMessage(`‚ùå WebAssemblyË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${error.message}`);
                console.error('WASM initialization error:', error);
            }
        }

        // „ÉÜ„Çπ„ÉàÁî®„ÅÆ„Ç´„Éº„ÇΩ„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Èñ¢Êï∞
        function startTestCursorAnimation() {
            setInterval(() => {
                remoteCursors.forEach((cursorData, playerId) => {
                    if (playerId.startsWith('test-')) {
                        // „É©„É≥„ÉÄ„É†„Å´Â∞ë„ÅóÁßªÂãï
                        const newX = cursorData.x + (Math.random() - 0.5) * 100;
                        const newY = cursorData.y + (Math.random() - 0.5) * 100;
                        
                        // ÁîªÈù¢ÁØÑÂõ≤ÂÜÖ„Å´Âà∂Èôê
                        const constrainedX = Math.max(0, Math.min(window.innerWidth - 50, newX));
                        const constrainedY = Math.max(0, Math.min(window.innerHeight - 50, newY));
                        
                        updateRemoteCursor(playerId, constrainedX, constrainedY);
                    }
                });
            }, 2000); // 2Áßí„Åî„Å®„Å´ÁßªÂãï
        }

        // „Éû„Ç¶„ÇπËøΩË∑°„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
        document.addEventListener('mousemove', (event) => {
            mousePosition.x = event.clientX;
            mousePosition.y = event.clientY;
            
            // WebSocket„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Éû„Ç¶„Çπ‰ΩçÁΩÆ„ÇíÈÄÅ‰ø°
            sendMousePosition(mousePosition.x, mousePosition.y);
        });

        // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÅÆËøΩË∑°
        document.addEventListener('click', (event) => {
            if (webSocket && webSocket.readyState === WebSocket.OPEN) {
                const clickMessage = {
                    type: 'GameAction',
                    player_id: localPlayerId,
                    player_name: 'Player1', // TODO: ÂÆüÈöõ„ÅÆ„Éó„É¨„Ç§„É§„ÉºÂêç„Çí‰ΩøÁî®
                    action: `„ÇØ„É™„ÉÉ„ÇØ (${event.clientX}, ${event.clientY})`,
                    x: event.clientX,
                    y: event.clientY,
                    timestamp: Date.now()
                };
                webSocket.send(JSON.stringify(clickMessage));
            }
            
            // „É≠„Éº„Ç´„É´„Åß„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç®„Éï„Çß„ÇØ„Éà
            createClickEffect(event.clientX, event.clientY);
        });

        // „ÇØ„É™„ÉÉ„ÇØ„Ç®„Éï„Çß„ÇØ„Éà‰ΩúÊàêÈñ¢Êï∞
        function createClickEffect(x, y) {
            const effect = document.createElement('div');
            effect.style.position = 'absolute';
            effect.style.left = `${x - 10}px`;
            effect.style.top = `${y - 10}px`;
            effect.style.width = '20px';
            effect.style.height = '20px';
            effect.style.borderRadius = '50%';
            effect.style.background = 'rgba(255, 255, 255, 0.8)';
            effect.style.pointerEvents = 'none';
            effect.style.animation = 'clickEffect 0.6s ease-out forwards';
            effect.style.zIndex = '9999';
            
            document.body.appendChild(effect);
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫ÜÂæå„Å´ÂâäÈô§
            setTimeout(() => {
                effect.remove();
            }, 600);
        }

        // CSS„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂãïÁöÑ„Å´ËøΩÂä†
        const style = document.createElement('style');
        style.textContent = `
            @keyframes clickEffect {
                0% {
                    transform: scale(0.5);
                    opacity: 1;
                }
                100% {
                    transform: scale(3);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÈñãÂßã
        initializeWasm();
        
        // „Éö„Éº„Ç∏ÁµÇ‰∫ÜÊôÇ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        window.addEventListener('beforeunload', () => {
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
            gameRunning = false;
            
            // WebSocketÊé•Á∂ö„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            if (webSocket) {
                webSocket.close();
            }
            
            // „É™„É¢„Éº„Éà„Ç´„Éº„ÇΩ„É´„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            remoteCursors.forEach((cursorData) => {
                if (cursorData.element) {
                    cursorData.element.remove();
                }
            });
            remoteCursors.clear();
        });
    </script>
</body>
</html>